#!/usr/bin/python3
import argparse
import json
import subprocess
import sys
import threading
import time
from typing import List, NamedTuple

from mininet.log import setLogLevel
from mn_wifi.cli import CLI
from mn_wifi.link import adhoc, wmediumd
from mn_wifi.net import Mininet_wifi
from mn_wifi.wmediumdConnector import interference

import location as loc

WIRELESS_CONF = {
    'cls': adhoc,
    'ssid': 'C4IAN-GLOBAL-SSID',
    'ht_cap': 'HT40+',
    'channel': 5,
    'mode': 'g',
}
PROPAGATION_MODEL = {
    'model': 'logDistance',
    'exp': 4,
}


class Position(NamedTuple):
    lon: int  # x
    lat: int  # y

    def __str__(self) -> str:
        return f'{self.lat},{self.lon},0'

    def to_mn(self):
        x, y = loc.to_mn_coords(self.lon, self.lat)
        return Position(x, y)


class Node(NamedTuple):
    name: str
    position: Position

    def get_sock(self):
        return f'/tmp/{self.name}.router.locsock'


def read_topo(path_to_json: str) -> List[Node]:
    with open(path_to_json) as f:
        topo = json.load(f)

    return [
        Node(node['name'],
             Position(node['lat'], node['lon']).to_mn())
        for node in topo['nodes']
    ], topo['range']


def parse_args():
    parser = argparse.ArgumentParser(
        description='Virtualize a topology using mininet-wifi.'
    )
    parser.add_argument('topology', help='Path to .topo file to load')

    parser.add_argument(
        '--plot', help='Show plot of the topology', action='store_true'
    )

    parser.add_argument(
        '-d', '--debug', help='Print debug level logs', action='store_true'
    )
    return parser.parse_args()


def nodes_locations_thread(stations, nodes):
    while True:
        for node in nodes:
            sock = node.get_sock()
            x, y, _ = stations[node.name].getxyz()
            lon, lat = loc.to_gps_coords(x, y)
            loc.send_location(sock, lon, lat)
        time.sleep(2)


args = parse_args()
nodes, rng = read_topo(args.topology)

setLogLevel('debug' if args.debug else 'info')

print("*** Creating mn-wifi net")
net = Mininet_wifi(link=wmediumd, wmediumd_mode=interference, plot=args.plot)

print("*** Creating nodes")
stations = {}
for node in nodes:
    stations[node.name] = net.addStation(
        node.name, position=str(node.position), range=rng
    )

print("*** Configuring wifi nodes")
net.configureWifiNodes()
net.setPropagationModel(**PROPAGATION_MODEL)

print("*** Creating links")
for node in nodes:
    net.addLink(
        stations[node.name],
        intf=f'{node.name}-wlan0',
        **WIRELESS_CONF
    )

if args.plot:
    print('*** Plotting topology')
    # TODO: select best (x,y) or set dynamically
    # TODO: update with mobility
    # TODO: make the window unfreaze
    net.plotGraph(max_x=500, max_y=500)

print("*** Starting network")
net.build()
print()

print('*** Starting to send nodes locations')
threading.Thread(target=nodes_locations_thread, args=(
    stations, nodes), daemon=True).start()

print("*** Running CLI")
CLI(net)

print("*** Stopping network")
net.stop()

print('*** Mininet clean')
subprocess.check_call(['mn', '-c'],
                      stdout=sys.stdout,
                      stderr=subprocess.STDOUT)
